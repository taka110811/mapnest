<!DOCTYPE html>
<html lang="en">
<head>
    <title>Japan Administrative Hierarchy Map</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.7.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.7.0/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
    <style>
        body, html, #map { height: 100%; margin: 0; padding: 0; }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1000;
        }
        .zoom-info {
            color: #666;
            margin-bottom: 5px;
        }
        .layer-info {
            font-weight: bold;
            color: #333;
        }
        .clickable-hint {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div class="info-panel">
    <div class="zoom-info">Zoom: <span id="current-zoom">5</span></div>
    <div class="layer-info">Layer: <span id="current-layer">éƒ½é“åºœçœŒ</span></div>
    <div class="clickable-hint">ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®éšå±¤ã¸</div>
</div>
<script>
    // Add PMTiles protocol
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const PMTILES_URL = 'http://localhost:8080/tiles/japan_all_levels_unified.pmtiles';
    const p = new pmtiles.PMTiles(PMTILES_URL);
    protocol.add(p);

    // Fetch header and create map
    p.getHeader().then(h => {
        console.log('PMTiles header:', h);
        
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
        p.getMetadata().then(metadata => {
            console.log('PMTiles metadata:', metadata);
            if (metadata && metadata.vector_layers) {
                console.log('Available vector layers:', metadata.vector_layers);
                metadata.vector_layers.forEach(layer => {
                    console.log(`Layer: ${layer.id}, Fields:`, layer.fields);
                });
            }
        }).catch(err => console.error('Metadata error:', err));
        
        const map = new maplibregl.Map({
            container: 'map',
            zoom: 5,
            center: [138.2529, 36.2048],
            style: {
                version: 8,
                sources: {
                    'osm-raster': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    },
                    'pmtiles_source': {
                        type: 'vector',
                        url: `pmtiles://${PMTILES_URL}`,
                        attribution: 'PMTiles Vector Data'
                    }
                },
                layers: [
                    {
                        'id': 'osm-tiles',
                        'type': 'raster',
                        'source': 'osm-raster',
                        'minzoom': 0,
                        'maxzoom': 22
                    },
                    // åœ°æ–¹ãƒ¬ãƒ™ãƒ« (Z3-6)
                    {
                        'id': 'regions-fill',
                        'type': 'fill',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 3,
                        'maxzoom': 6,
                        'filter': ['==', ['get', 'level'], 'region'],
                        'paint': {
                            'fill-color': ['get', 'color'],
                            'fill-opacity': 0.7
                        }
                    },
                    {
                        'id': 'regions-stroke',
                        'type': 'line',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 3,
                        'maxzoom': 6,
                        'filter': ['==', ['get', 'level'], 'region'],
                        'paint': {
                            'line-color': '#333333',
                            'line-width': 2,
                            'line-opacity': 0.8
                        }
                    },
                    // éƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ« (Z6-8)
                    {
                        'id': 'prefectures-fill',
                        'type': 'fill',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 6,
                        'maxzoom': 8,
                        'filter': ['==', ['get', 'level'], 'prefecture'],
                        'paint': {
                            'fill-color': ['get', 'color'],
                            'fill-opacity': 0.7
                        }
                    },
                    {
                        'id': 'prefectures-stroke',
                        'type': 'line',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 6,
                        'maxzoom': 8,
                        'filter': ['==', ['get', 'level'], 'prefecture'],
                        'paint': {
                            'line-color': '#333333',
                            'line-width': 1.5,
                            'line-opacity': 0.8
                        }
                    },
                    // å¸‚åŒºç”ºæ‘ãƒ¬ãƒ™ãƒ« (Z8-11)
                    {
                        'id': 'municipalities-fill',
                        'type': 'fill',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 8,
                        'maxzoom': 11,
                        'filter': ['==', ['get', 'level'], 'municipality'],
                        'paint': {
                            'fill-color': ['get', 'color'],
                            'fill-opacity': 0.7
                        }
                    },
                    {
                        'id': 'municipalities-stroke',
                        'type': 'line',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 8,
                        'maxzoom': 11,
                        'filter': ['==', ['get', 'level'], 'municipality'],
                        'paint': {
                            'line-color': '#333333',
                            'line-width': 1,
                            'line-opacity': 0.8
                        }
                    },
                    // è©³ç´°ãƒ¬ãƒ™ãƒ« (Z11+)
                    {
                        'id': 'detailed-fill',
                        'type': 'fill',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 11,
                        'filter': ['==', ['get', 'level'], 'detailed'],
                        'paint': {
                            'fill-color': ['get', 'color'],
                            'fill-opacity': 0.7
                        }
                    },
                    {
                        'id': 'detailed-stroke',
                        'type': 'line',
                        'source': 'pmtiles_source',
                        'source-layer': 'japan_unified',
                        'minzoom': 11,
                        'filter': ['==', ['get', 'level'], 'detailed'],
                        'paint': {
                            'line-color': '#333333',
                            'line-width': 0.5,
                            'line-opacity': 0.8
                        }
                    }
                ]
            }
        });

        map.on('load', () => {
            console.log('Map loaded successfully');
            
            // ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’ç¢ºèª
            const source = map.getSource('pmtiles_source');
            console.log('Source:', source);
            
            // åˆ©ç”¨å¯èƒ½ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç¢ºèª
            setTimeout(() => {
                try {
                    // ã‚½ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®šã›ãšã«å…¨ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’ã‚¯ã‚¨ãƒª
                    const allFeatures = map.querySourceFeatures('pmtiles_source');
                    console.log('All features found:', allFeatures.length);
                    
                    // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°èª¿æŸ»
                    if (allFeatures.length > 0) {
                        console.log('=== PMTiles Layer Analysis ===');
                        console.log('Total features found:', allFeatures.length);
                        console.log('Sample feature:', allFeatures[0]);
                        console.log('Source layer from feature:', allFeatures[0].sourceLayer);
                        console.log('Feature properties:', allFeatures[0].properties);
                        
                        // level ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
                        const levelValues = [...new Set(allFeatures.map(f => f.properties.level))].filter(Boolean);
                        console.log('Available level values:', levelValues);
                        
                        // å„éšå±¤ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ•°
                        levelValues.forEach(level => {
                            const count = allFeatures.filter(f => f.properties.level === level).length;
                            console.log(`${level}: ${count} features`);
                            
                            // å„éšå±¤ã®ã‚µãƒ³ãƒ—ãƒ«
                            const sample = allFeatures.find(f => f.properties.level === level);
                            if (sample) {
                                console.log(`${level} sample properties:`, sample.properties);
                            }
                        });
                        
                        // color ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
                        const colorValues = [...new Set(allFeatures.map(f => f.properties.color))].filter(Boolean);
                        console.log('Available color values:', colorValues);
                    }
                    
                    // å¯èƒ½æ€§ã®ã‚ã‚‹ã‚½ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å†ç¢ºèª
                    const possibleLayers = ['default', 'japan', 'japan_ver85', 'boundaries', 'layer0', 'data', 'regions', 'prefectures', 'municipalities', 'detailed'];
                    possibleLayers.forEach(layerName => {
                        const layerFeatures = map.querySourceFeatures('pmtiles_source', { sourceLayer: layerName });
                        if (layerFeatures.length > 0) {
                            console.log(`Layer '${layerName}' has ${layerFeatures.length} features`);
                        }
                    });
                } catch (error) {
                    console.error('Error querying features:', error);
                }
            }, 3000);
        });

        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«å¤‰æ›´æ™‚ã®æƒ…å ±æ›´æ–°
        function updateLayerInfo(zoom) {
            let layerName = '';
            if (zoom >= 3 && zoom < 6) {
                layerName = 'åœ°æ–¹';
            } else if (zoom >= 6 && zoom < 8) {
                layerName = 'éƒ½é“åºœçœŒ';
            } else if (zoom >= 8 && zoom < 11) {
                layerName = 'å¸‚åŒºç”ºæ‘';
            } else if (zoom >= 11) {
                layerName = 'è©³ç´°';
            }
            
            document.getElementById('current-zoom').textContent = zoom.toFixed(1);
            document.getElementById('current-layer').textContent = layerName;
        }

        map.on('load', () => {
            updateLayerInfo(map.getZoom());
        });

        map.on('zoom', () => {
            updateLayerInfo(map.getZoom());
        });

        // ã‚¿ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚ºãƒ¼ãƒ ã‚¤ãƒ³æ©Ÿèƒ½
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point);
            if (features.length > 0) {
                const feature = features[0];
                const props = feature.properties;
                const currentZoom = map.getZoom();
                
                // éšå±¤ã«å¿œã˜ãŸæ¬¡ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã¨ã‚»ãƒ³ã‚¿ãƒ¼è¨ˆç®—
                let targetZoom = currentZoom + 2;
                let shouldZoom = false;
                
                // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—
                const bounds = new maplibregl.LngLatBounds();
                if (feature.geometry.type === 'Polygon') {
                    feature.geometry.coordinates[0].forEach(coord => {
                        bounds.extend(coord);
                    });
                } else if (feature.geometry.type === 'MultiPolygon') {
                    feature.geometry.coordinates.forEach(polygon => {
                        polygon[0].forEach(coord => {
                            bounds.extend(coord);
                        });
                    });
                }
                
                // éšå±¤åˆ¥ã®ã‚ºãƒ¼ãƒ å‡¦ç†
                if (props.level === 'region' && currentZoom < 6) {
                    targetZoom = 7; // éƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
                    shouldZoom = true;
                } else if (props.level === 'prefecture' && currentZoom < 8) {
                    targetZoom = 9; // å¸‚åŒºç”ºæ‘ãƒ¬ãƒ™ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
                    shouldZoom = true;
                } else if (props.level === 'municipality' && currentZoom < 11) {
                    targetZoom = 12; // è©³ç´°ãƒ¬ãƒ™ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
                    shouldZoom = true;
                }
                
                if (shouldZoom) {
                    // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    map.fitBounds(bounds, {
                        padding: 50,
                        maxZoom: targetZoom,
                        duration: 300
                    });
                } else {
                    // è©³ç´°æƒ…å ±ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆæœ€ä¸‹ä½ãƒ¬ãƒ™ãƒ«ã¾ãŸã¯ã‚ºãƒ¼ãƒ ä¸è¦ãªå ´åˆï¼‰
                    let content = '<h3>åœ°åŸŸæƒ…å ±</h3>';
                    if (props.level === 'region') {
                        content += `<p><strong>åœ°æ–¹:</strong> ${props.region_jp}</p>`;
                        content += `<p><strong>äººå£:</strong> ${props.population?.toLocaleString() || 'N/A'}</p>`;
                        content += `<p><strong>ä¸–å¸¯æ•°:</strong> ${props.households?.toLocaleString() || 'N/A'}</p>`;
                    } else if (props.level === 'prefecture') {
                        content += `<p><strong>éƒ½é“åºœçœŒ:</strong> ${props.prefecture_jp}</p>`;
                        content += `<p><strong>åœ°æ–¹:</strong> ${props.region_jp}</p>`;
                        content += `<p><strong>JISã‚³ãƒ¼ãƒ‰:</strong> ${props.jis_code}</p>`;
                        content += `<p><strong>äººå£:</strong> ${props.population?.toLocaleString() || 'N/A'}</p>`;
                    } else if (props.level === 'municipality') {
                        content += `<p><strong>å¸‚åŒºç”ºæ‘:</strong> ${props.municipality_jp}</p>`;
                        content += `<p><strong>éƒ½é“åºœçœŒ:</strong> ${props.prefecture_jp}</p>`;
                        content += `<p><strong>ã‚³ãƒ¼ãƒ‰:</strong> ${props.jcode}</p>`;
                        content += `<p><strong>äººå£:</strong> ${props.population?.toLocaleString() || 'N/A'}</p>`;
                    } else if (props.level === 'detailed') {
                        content += `<p><strong>åœ°åŸŸ:</strong> ${props.SIKUCHOSON || 'N/A'}</p>`;
                        content += `<p><strong>éƒ½é“åºœçœŒ:</strong> ${props.KEN || 'N/A'}</p>`;
                        content += `<p><strong>äººå£:</strong> ${props.P_NUM?.toLocaleString() || 'N/A'}</p>`;
                        content += `<p><strong>ä¸–å¸¯æ•°:</strong> ${props.H_NUM?.toLocaleString() || 'N/A'}</p>`;
                        content += `<p class="zoom-note" style="color: #666; font-size: 11px; margin-top: 8px;">ğŸ’¡ ã“ã‚Œä»¥ä¸Šè©³ç´°ãªãƒ¬ãƒ™ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
                    }

                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(content)
                        .addTo(map);
                }
            }
        });

        // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼åŠ¹æœ
        map.on('mouseenter', ['regions-fill', 'prefectures-fill', 'municipalities-fill', 'detailed-fill'], () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', ['regions-fill', 'prefectures-fill', 'municipalities-fill', 'detailed-fill'], () => {
            map.getCanvas().style.cursor = '';
        });

        map.on('error', (e) => {
            console.error('Map error:', e);
        });
    }).catch(error => {
        console.error('Failed to load PMTiles header:', error);
    });
</script>
</body>
</html>